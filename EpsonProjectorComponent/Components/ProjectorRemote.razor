@inject ProjectorControllerService Controller

<div class="projector-remote container-fluid px-0">
    <div class="remote-header mb-3">
        <div>
            @if (!string.IsNullOrWhiteSpace(Title))
            {
                <h1 class="h4 mb-1">@Title</h1>
            }
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="badge rounded-pill @(useSimulator ? "bg-warning text-dark" : "bg-info text-dark")">
                    @(useSimulator ? "Simulator" : "Hardware")
                </span>
                <span class="badge rounded-pill @(Controller.Status.IsConnected ? "bg-success" : "bg-secondary")">
                    @(Controller.Status.IsConnected ? "Connected" : "Disconnected")
                </span>
            </div>
        </div>
        <button class="btn btn-outline-light settings-btn" title="Settings" @onclick="OpenSettings">
            <span class="oi oi-cog" aria-hidden="true"></span>
            <span>Settings</span>
        </button>
    </div>

    <div class="remote-shell card remote-card">
        <div class="card-body">
            <div class="remote-surface mx-auto">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="small text-light-emphasis">Projector Remote</span>
                    <span class="badge rounded-pill @(Controller.Status.IsConnected ? "bg-success" : "bg-secondary")">
                        @(Controller.Status.IsConnected ? "Online" : "Offline")
                    </span>
                </div>

                <div class="power-row">
                    <button class="btn btn-success btn-lg remote-btn" @onclick="PowerOnAsync" disabled="@(!Controller.IsConnected || isBusy)">Power On</button>
                    <button class="btn btn-danger btn-lg remote-btn" @onclick="PowerOffAsync" disabled="@(!Controller.IsConnected || isBusy)">Power Off</button>
                </div>

                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-warning remote-btn" @onclick="ToggleMuteAsync" disabled="@(!Controller.IsConnected || isBusy)">
                        @(Controller.Status.IsMuted ? "Unmute" : "Mute")
                    </button>
                </div>

                <div class="mt-3">
                    <label class="form-label text-light mb-1">Input Source</label>
                    <div class="input-group">
                        <select class="form-select" @bind="selectedSource" disabled="@(!Controller.IsConnected || isBusy)">
                            @foreach (var source in _sources)
                            {
                                <option value="@source">@source</option>
                            }
                        </select>
                        <button class="btn btn-secondary" @onclick="SetSourceAsync" disabled="@(!Controller.IsConnected || isBusy)">Apply</button>
                    </div>
                </div>
            </div>

            <div class="status-panel mt-3">
                <div class="status-chip"><span>Power</span><strong>@(Controller.Status.IsPoweredOn ? "On" : "Off")</strong></div>
                <div class="status-chip"><span>Mute</span><strong>@(Controller.Status.IsMuted ? "On" : "Off")</strong></div>
                <div class="status-chip"><span>Source</span><strong>@Controller.Status.ActiveSource</strong></div>
            </div>

            @if (useSimulator)
            {
                <div class="sim-panel mt-3">
                    <div class="small text-muted">
                        Sim Power: @(Controller.Status.IsPoweredOn ? "On" : "Off") |
                        Sim Mute: @(Controller.Status.IsMuted ? "On" : "Off") |
                        Sim Source: @Controller.Status.ActiveSource
                    </div>
                </div>
            }

            <div class="alert alert-secondary mt-3 mb-0">
                <div><strong>Response:</strong> @Controller.Status.LastResponse</div>
                <div class="small text-muted">Updated @Controller.Status.LastUpdatedUtc.LocalDateTime</div>
            </div>
        </div>
    </div>
</div>

@if (showSettings)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Projector Settings</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseSettings"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-sm-8">
                            <label class="form-label">Host</label>
                            <input class="form-control" @bind="settingsConnection.Host" />
                        </div>
                        <div class="col-sm-4">
                            <label class="form-label">Port</label>
                            <input type="number" class="form-control" @bind="settingsConnection.Port" />
                        </div>
                        <div class="col-sm-6">
                            <div class="form-check form-switch mt-2">
                                <input id="modal-https" type="checkbox" class="form-check-input" @bind="settingsConnection.UseHttps" />
                                <label class="form-check-label" for="modal-https">Use HTTPS</label>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-check form-switch mt-2">
                                <input id="modal-sim" type="checkbox" class="form-check-input" @bind="settingsUseSimulator" />
                                <label class="form-check-label" for="modal-sim">Use Simulator</label>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label">Username</label>
                            <input class="form-control" @bind="settingsConnection.Username" disabled="@settingsUseSimulator" />
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" @bind="settingsConnection.Password" disabled="@settingsUseSimulator" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" @onclick="CloseSettings" disabled="@isBusy">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveAndConnectAsync" disabled="@isBusy">
                        @(isBusy ? "Working..." : "Save and Connect")
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (showConnectionToast)
{
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div class="toast show text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    @connectionToastMessage
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close" @onclick="DismissConnectionToast"></button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string? Title { get; set; } = "Epson Projector Web Remote";

    [Parameter]
    public IReadOnlyList<string>? Sources { get; set; }

    [Parameter]
    public EventCallback<ProjectorStatus> OnStatusChanged { get; set; }

    private readonly string[] _defaultSources = new[] { "HDMI1", "HDMI2", "VGA", "LAN" };
    private IReadOnlyList<string> _sources = Array.Empty<string>();
    private ProjectorConnectionOptions connection = new();
    private ProjectorConnectionOptions settingsConnection = new();
    private string selectedSource = "HDMI1";
    private bool useSimulator = true;
    private bool settingsUseSimulator = true;
    private bool isBusy;
    private bool showSettings;
    private bool autoConnectAttempted;
    private bool showConnectionToast;
    private string connectionToastMessage = string.Empty;

    protected override void OnParametersSet()
    {
        _sources = Sources is { Count: > 0 } ? Sources : _defaultSources;
        if (!_sources.Contains(selectedSource, StringComparer.OrdinalIgnoreCase))
        {
            selectedSource = _sources[0];
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || autoConnectAttempted)
        {
            return;
        }

        autoConnectAttempted = true;
        var result = await ExecuteAsync(() => Controller.ConnectAsync(connection, useSimulator));
        HandleConnectionFailure(result);
    }

    private void OpenSettings()
    {
        settingsConnection = new ProjectorConnectionOptions
        {
            Host = connection.Host,
            Port = connection.Port,
            UseHttps = connection.UseHttps,
            Username = connection.Username,
            Password = connection.Password
        };
        settingsUseSimulator = useSimulator;
        showSettings = true;
    }

    private void CloseSettings()
    {
        showSettings = false;
    }

    private async Task SaveAndConnectAsync()
    {
        connection = new ProjectorConnectionOptions
        {
            Host = settingsConnection.Host,
            Port = settingsConnection.Port,
            UseHttps = settingsConnection.UseHttps,
            Username = settingsConnection.Username,
            Password = settingsConnection.Password
        };
        useSimulator = settingsUseSimulator;

        var result = await ExecuteAsync(() => Controller.ConnectAsync(connection, useSimulator));
        HandleConnectionFailure(result);
        if (result.Success || useSimulator)
        {
            showSettings = false;
        }
    }

    private async Task PowerOnAsync()
    {
        await ExecuteAsync(() => Controller.PowerOnAsync());
    }

    private async Task PowerOffAsync()
    {
        await ExecuteAsync(() => Controller.PowerOffAsync());
    }

    private async Task ToggleMuteAsync()
    {
        await ExecuteAsync(() => Controller.SetMuteAsync(!Controller.Status.IsMuted));
    }

    private async Task SetSourceAsync()
    {
        await ExecuteAsync(() => Controller.SetSourceAsync(selectedSource));
    }

    private async Task<ProjectorCommandResult> ExecuteAsync(Func<Task<ProjectorCommandResult>> action)
    {
        isBusy = true;
        try
        {
            var result = await action();
            if (OnStatusChanged.HasDelegate)
            {
                await OnStatusChanged.InvokeAsync(Controller.Status);
            }
            return result;
        }
        finally
        {
            isBusy = false;
        }
    }

    private void HandleConnectionFailure(ProjectorCommandResult result)
    {
        if (useSimulator || result.Success)
        {
            return;
        }

        connectionToastMessage = "Can't connect to projector. Check IP, credentials, and network access.";
        showConnectionToast = true;
        _ = AutoDismissConnectionToastAsync();
    }

    private void DismissConnectionToast()
    {
        showConnectionToast = false;
    }

    private async Task AutoDismissConnectionToastAsync()
    {
        await Task.Delay(5000);
        showConnectionToast = false;
        await InvokeAsync(StateHasChanged);
    }
}
